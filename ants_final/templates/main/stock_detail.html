{% extends 'base.html' %}
{% load static %}

{% block title %}ANTS{% endblock %}

{% block content %}
<div class="container">
    <form method="GET" action="{% url 'stock_search' %}">
        <input type="text" name="stock_query" placeholder="종목 코드 또는 종목명을 입력하세요" required>
        <button type="submit" class="btn btn-dark">검색</button>
    </form>
</div>

<!-- 차트, 버튼 그룹, 종목 정보를 나란히 배치 -->
<div class="container">
    <div class="row justify-content-center">
        <!-- 차트 -->
        <div class="col-lg-6 p-2">
            <h2 class="text-center"><strong>{{ name }}</strong>({{ stock_code }})
                <img id="favorite-icon" src="{% static favorite_icon %}" alt="Favorite Icon" style="width: 30px; height: 30px; cursor: pointer;">
            </h2>
            <canvas id="stockChart"></canvas>
        </div>

        <!-- 버튼 그룹을 차트 오른쪽에 세로로 배치 -->
        <div class="col-lg-1 p-3">
            <div class="btn-group-vertical" role="group" aria-label="X축 범위 선택" id="rangeButtons" style="width: 100%;">
                <button id="range0" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">1일</button>
                <button id="range1" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">1년</button>
                <button id="range5" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">5년</button>
                <button id="range10" class="btn btn-primary active" style="width: 100%; margin-bottom: 10px;">10년</button>
            </div>
        </div>

        <!-- 주식 종목 정보를 버튼 오른쪽에 배치 -->
        <div class="col-lg-4 p-2">
            <h2 class="text-center">주식 종목 정보</h2>            
            <p class="text-center">주식 MBTI: {{ mbti|default:"정보 없음" }}</p>
            <p class="text-center">배당성: {{ dividend_stability }}</p>
            <p class="text-center">변동성: {{ volatility }}</p>
            <p class="text-center">전년도 배당률: {{ prev_dividend_rate }}</p>
            <p class="text-center">예측 배당률: {{ pred_dividend_rate }}</p>
        </div>
    </div>
</div>

<div class="news-section">
    <h3 class="text-center">주요 뉴스</h3>
    <div class="news-carousel">
        <button id="prevBtn">&lt;</button>
        <div id="newsWrapper">
            {% for news in news_list %}
                <div class="news-item">
                    <a href="{{ news.originallink }}" style="color: black; text-decoration: none;" target="_blank">
                        <h4>{{ news.title|safe }}</h4>
                        <p>{{ news.description|safe }}</p>
                    </a>
                    <p>{{ news.pubDate|slice:":16" }}</p>
                </div>
            {% endfor %}
        </div>
        <button id="nextBtn">&gt;</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0"></script>

<script>
    const dates = {{ dates|safe }};
    const closingPrices = {{ closing_prices|safe }};
    const stock_code = "{{ stock_code }}";
    const ma5 = {{ ma5|safe }};
    const ma20 = {{ ma20|safe }};
    const ma60 = {{ ma60|safe }};
    const ma120 = {{ ma120|safe }};
    const maxDate = new Date(dates[dates.length - 1]);
    const candleData = {{ candle_data|safe }}.map(item => {
        return {
            ...item,
            x: new Date(item.x)  // 문자열을 Date 객체로 변환
        };
    });
    console.log("변환된 candleData 값:", candleData);

    // stockChart 전역 변수로 선언
    let stockChart;

    function fetchRealTimeData() {
        // 오늘 날짜 계산
        const today = new Date().toISOString().split('T')[0];  // 오늘 날짜 (YYYY-MM-DD 형식)
        
        // 오늘 날짜 데이터만 필터링
        const todayData = candleData.filter(item => {
            // item.x가 Date 객체일 경우 처리
            if (item.x instanceof Date) {
                return item.x.toISOString().startsWith(today);  // Date 객체를 ISO 문자열로 변환 후 필터링
            } else if (typeof item.x === 'string') {
                return item.x.startsWith(today);  // 문자열인 경우 그대로 필터링
            } else {
                console.error("item.x는 Date 객체나 문자열이 아닙니다:", item.x);
                return false;
            }
        });
        
      // 기존 라인차트를 제거하고 캔들차트로 변경
        if (stockChart) {
            stockChart.destroy();  // 기존 차트를 삭제
        }

    stockChart.destroy();  // 기존 차트를 삭제
    const stockChart = new Chart(document.getElementById('stockChart').getContext('2d'), {
        type: 'candlestick',
        data: {
            datasets: [{
                label: '1일 캔들차트',
                data: candleData,  // 변환된 오늘 날짜 데이터
                borderColor: 'rgba(14, 138, 117, 1)'
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: {
                            minute: 'HH:mm',  // 분 단위 표시 형식
                            hour: 'HH:mm'
                        }
                    },
                    title: { display: true, text: '시간' },
                    adapters: {
                        date: {
                            locale: enUS, // 'enUS'와 같은 로케일 설정이 필요할 수 있음
                            timezone: 'UTC'  // 타임존을 UTC로 맞추기 (또는 다른 타임존)
                        }
                    }
                },
                y: {
                    title: { display: true, text: '가격 (원)' },
                    beginAtZero: false
                }
            }
        }
    });
}


function calculateMinDate(years) {
    const minDate = new Date(maxDate);
    minDate.setFullYear(minDate.getFullYear() - years);
    return minDate.toISOString().split('T')[0];
}
    // 라인 차트 설정
    stockChart = new Chart(document.getElementById('stockChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: '종가',
                data: closingPrices,
                borderColor: 'rgba(14, 138, 117, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 1,
                pointRadius: 0,
                tension: 0.1
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'time',
                    min: calculateMinDate(10),
                    max: maxDate.toISOString().split('T')[0],
                    title: { display: true, text: '날짜' }
                },
                y: { title: { display: true, text: '가격 (원)' }, beginAtZero: false }
            }
        }
    });

    const rangeButtons = document.querySelectorAll('#rangeButtons button');

    rangeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const years = parseInt(this.id.replace('range', ''));
            if (years === 0) {
                // 1일 버튼 클릭 시 실시간 데이터를 가져와 봉차트로 업데이트
                fetchRealTimeData();
            } else {
                updateChartRange(years, this);
            }
        });
    });

   
    

    function updateChartRange(years, clickedButton) {
        const showMovingAverages = years === 1;

        stockChart.options.scales.x.min = calculateMinDate(years);

        stockChart.data.datasets = [{
            label: '종가',
            data: closingPrices,
            borderColor: 'rgba(14, 138, 117, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            pointRadius: 0,
            borderWidth: 1,
            tension: 0.1
        }];

        if (showMovingAverages) {
            stockChart.data.datasets.push(
                { label: 'MA5', data: ma5, borderColor: 'rgba(255, 99, 132, 1)', pointRadius: 0, borderWidth: 0.8,tension: 0.1 },
                { label: 'MA20', data: ma20, borderColor: 'rgba(54, 162, 235, 1)', pointRadius: 0,borderWidth: 0.8,tension: 0.1 },
                { label: 'MA60', data: ma60, borderColor: 'rgba(255, 206, 86, 1)', pointRadius: 0, borderWidth: 0.8,tension: 0.1 },
                { label: 'MA120', data: ma120, borderColor: 'rgba(75, 192, 192, 1)', pointRadius: 0, borderWidth: 0.5,tension: 0.1 }
            );
        }

        stockChart.update();

        rangeButtons.forEach(btn => {
            btn.classList.remove('btn-primary', 'active');
            btn.classList.add('btn-secondary');
        });

        clickedButton.classList.remove('btn-secondary');
        clickedButton.classList.add('btn-primary', 'active');
    }

    // 뉴스 페이징 및 관심 종목 추가/제거 기능
    let currentPage = 1;
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    function loadNews(page) {
        fetch(`/load-news/?stock_code=${stock_code}&page=${page}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('newsWrapper').innerHTML = '';
                data.news_list.forEach(news => {
                    const newsItem = `
                        <div class="news-item">
                            <a href="${news.originallink}" style="color: black; text-decoration: none;" target="_blank">
                                <h4>${news.title}</h4>
                                <p>${news.description}</p>
                            </a>
                            <p>${news.pubDate.slice(0, 16)}</p>
                        </div>
                    `;
                    document.getElementById('newsWrapper').insertAdjacentHTML('beforeend', newsItem);
                });
            })
            .catch(error => console.error('Error fetching news:', error));
    }

    prevBtn.addEventListener('click', () => {
        if (currentPage > 1) currentPage--;
        loadNews(currentPage);
    });

    nextBtn.addEventListener('click', () => {
        currentPage++;
        loadNews(currentPage);
    });

    const isAuthenticated = "{{ user.is_authenticated|yesno:'true,false' }}";
    document.getElementById('favorite-icon').addEventListener('click', function() {
        if (isAuthenticated === 'false') {
            alert('로그인이 필요합니다.');
            window.location.href = "{% url 'account_login' %}?next={{ request.path }}";
            return;
        }

        const isFavorite = this.getAttribute('src').includes('filled_star.png');
        const url = isFavorite ? `/remove_stock/${stock_code}/` : `/add_favorite_list/${stock_code}/`;

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(response => {
            if (response.ok) {
                this.setAttribute('src', isFavorite ? "{% static 'images/empty_star.png' %}" : "{% static 'images/filled_star.png' %}");
            } else {
                console.error('Error processing request');
            }
        })
        .catch(error => console.error('Error:', error));
    });
</script>
{% endblock %}
