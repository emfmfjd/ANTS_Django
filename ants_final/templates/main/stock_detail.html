{% extends 'base.html' %}
{% load static %}

{% block title %}ANTS{% endblock %}

{% block content %}
<div class="container">
    <form method="GET" action="{% url 'stock_search' %}">
        <input type="text" name="stock_query" placeholder="종목 코드 또는 종목명을 입력하세요" required>
        <button type="submit" class="btn btn-dark">검색</button>
    </form>
</div>

<!-- 차트, 버튼 그룹, 종목 정보를 나란히 배치 -->
<div class="container">
    <div class="row justify-content-center">
        <!-- 차트 -->
        <div class="col-lg-6 p-2">
            <h2 class="text-center"><strong>{{ name }}</strong>({{ stock_code }})
                <img id="favorite-icon" src="{% static favorite_icon %}" alt="Favorite Icon" style="width: 30px; height: 30px; cursor: pointer;">
            </h2>
            <canvas id="stockChart"></canvas>
        </div>

        <!-- 버튼 그룹을 차트 오른쪽에 세로로 배치 -->
        <div class="col-lg-1 p-3">
            <div class="btn-group-vertical" role="group" aria-label="X축 범위 선택" id="rangeButtons" style="width: 100%;">
                <button id="range0" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">1일</button>
                <button id="range1" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">1년</button>
                <button id="range5" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">5년</button>
                <button id="range10" class="btn btn-primary active" style="width: 100%; margin-bottom: 10px;">10년</button>
            </div>
        </div>

        <!-- 주식 종목 정보를 버튼 오른쪽에 배치 -->
        <div class="col-lg-4 p-2">
            <h2 class="text-center">주식 종목 정보</h2>            
            <p class="text-center">주식 MBTI: {{ mbti|default:"정보 없음" }}</p>
            <p class="text-center">배당성: {{ dividend_stability }}</p>
            <p class="text-center">변동성: {{ volatility }}</p>
            <p class="text-center">전년도 배당률: {{ prev_dividend_rate }}</p>
            <p class="text-center">예측 배당률: {{ pred_dividend_rate }}</p>
        </div>
    </div>
</div>

<div class="news-section">
    <h3 class="text-center">주요 뉴스</h3>
    <div class="news-carousel">
        <button id="prevBtn">&lt;</button>
        <div id="newsWrapper">
            {% for news in news_list %}
                <div class="news-item">
                    <a href="{{ news.originallink }}" style="color: black; text-decoration: none;" target="_blank">
                        <h4>{{ news.title|safe }}</h4>
                        <p>{{ news.description|safe }}</p>
                    </a>
                    <p>{{ news.pubDate|slice:":16" }}</p>
                </div>
            {% endfor %}
        </div>
        <button id="nextBtn">&gt;</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns/locale/en-US/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>

<script>
    const dates = {{ dates|safe }};
    const closingPrices = {{ closing_prices|safe }};
    const stock_code = "{{ stock_code }}";
    const ma5 = {{ ma5|safe }};
    const ma20 = {{ ma20|safe }};
    const ma60 = {{ ma60|safe }};
    const ma120 = {{ ma120|safe }};
    const maxDate = new Date(dates[dates.length - 1]);
    const candleData = {{ candle_data|safe }}
        

    // stockChart 전역 변수로 선언
    let stockChart;

    function fetchRealTimeData() {
        // 오늘 날짜를 계산
        const today = new Date().toISOString().split('T')[0];  // 오늘 날짜 (YYYY-MM-DD 형식)
        let previousClose = null;

        // 데이터가 오늘 날짜에 있는지 확인
        let filteredData = candleData.filter(item => {
            const itemDate = new Date(item.x);  // item.x를 Date로 변환
            const itemDateStr = itemDate.toISOString().split('T')[0];  // 날짜만 추출
            return itemDateStr === today;
        });

        // 만약 오늘 날짜의 데이터가 없으면 가장 최근 데이터 사용
        if (filteredData.length === 0) {
            // 가장 최근 날짜 찾기
            const mostRecentDateStr = candleData.reduce((latest, item) => {
                const itemDate = new Date(item.x);
                const latestDate = new Date(latest);
                return itemDate > latestDate ? item.x : latest;
            }, candleData[0].x);
            
            // 가장 최근 날짜에 해당하는 데이터 필터링
            filteredData = candleData.filter(item => {
                const itemDate = new Date(item.x);
                const recentDateStr = new Date(mostRecentDateStr).toISOString().split('T')[0];
                return itemDate.toISOString().split('T')[0] === recentDateStr;
            });
        }

        // 이전 종가를 기준으로 색상 설정
        const todayData = filteredData.map(item => {
            let isUp = false;

            if (previousClose !== null) {
                // 현재 종가가 이전 종가보다 크면 상승, 작으면 하락
                isUp = item.c > previousClose;
            }

            // 시가를 이전 종가로 설정
            const open = previousClose !== null ? previousClose : item.o; 

            // 다음 데이터를 위해 이전 종가를 업데이트
            previousClose = item.c;

            return { 
                x: new Date(item.x), 
                o: open,  // 시가를 이전 종가로 설정
                h: Math.max(open, item.c),  // 고가와 종가 또는 시가 동일하게 설정
                l: Math.min(open, item.c),  // 저가를 시가와 동일하게 설정
                c: item.c,
              
            };
        });

        // 라인차트를 위한 현재가 데이터
        const lineData = filteredData.map(item => {
            return { x: new Date(item.x), y: item.c };  // 라인차트는 x축 시간과 y축 가격
        });

        console.log("필터링된 오늘 또는 최근 데이터:", todayData);
        console.log("현재가 라인 데이터:", lineData);

        // 기존 차트를 삭제하고 캔들차트로 변경
        if (stockChart) {
            stockChart.destroy();  // 기존 차트를 삭제
        }

        stockChart = new Chart(document.getElementById('stockChart').getContext('2d'), {
            type: 'candlestick',  // 기본 캔들차트
            data: {
                datasets: [
                    {
                        label: '1일 캔들차트',
                        data: todayData,
                        barThickness: 'flex',
                        hoverBackgroundColor: 'rgba(14, 138, 117, 0.3)',
                        backgroundColors: {
                            up: 'rgba(246, 8, 8, 0.7)',  // 양봉 (종가 > 시가) 배경색
                            down: 'rgba(0, 0, 200, 0.7)',  // 음봉 (종가 < 시가) 배경색
                        },
                        borderColors: {
                            up: 'rgb(200, 0, 0)',  // 양봉 (종가 > 시가) 경계선 색
                            down: 'rgb(0, 0, 200)',  // 음봉 (종가 < 시가) 경계선 색
                        }
                        
                    },
                    {
                        label: '현재가',
                        type: 'line',  // 추가된 라인차트
                        data: lineData,
                        borderColor: 'rgba(14, 138, 117, 1)',  
                        backgroundColor: 'rgba(14, 138, 117, 0.5)',  // 라인 배경색
                        borderWidth: 1,
                        pointRadius: 0.2,
                        tension: 0.1,  // 부드러운 라인
                    }
                ]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',  // 데이터가 10분 간격일 때 분 단위로 설정
                            displayFormats: {
                                minute: 'HH:mm',  // 시:분 형식으로 표시
                            },
                            tooltipFormat: 'yyyy-MM-dd HH:mm',  // 툴팁에 표시할 형식
                        },
                        title: {
                            display: true,
                            text: '시간 (KST)'  // 시간대 명시
                        },
                        ticks: {
                            source: 'auto',  // 자동으로 데이터를 기반으로 tick 설정
                            autoSkip: true,  // 자동으로 일부 tick 생략
                            maxTicksLimit: 10,  // 최대 10개의 tick만 표시
                            callback: function(value, index, values) {
                                // Date 객체로 변환 후 한국 시간(KST)으로 9시간 더함
                                const date = new Date(value);
                                date.setHours(date.getHours() - 9);  // 9시간을 더해 한국 시간으로 변환
                                return date.toLocaleTimeString('ko-KR', {
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    hour12: true
                                });
                            }
                        }
                    },
                    
                    y: {
                        title: { display: true, text: '가격 (원)' },
                        beginAtZero: false  // 가격은 0부터 시작하지 않도록 설정
                    }
                },
                plugins: {
                    legend: {
                        display: false,  // 범례를 표시하지 않음
                    },
                    tooltip: {
                        callbacks: {
                            // 상단에 표시되는 제목을 빈 문자열로 설정하여 삭제
                            title: function() {
                                return '';  // 제목(날짜/시간) 표시 제거
                            },
                            label: function(tooltipItem) {
                                // 캔들 차트만 툴팁 표시
                                if (tooltipItem.datasetIndex === 0) {  // 캔들 차트의 데이터셋 인덱스가 0으로 가정
                                    const currentPrice = tooltipItem.raw.c ? tooltipItem.raw.c.toLocaleString('ko-KR', { style: 'currency', currency: 'KRW' }) : '₩0';
                    
                                    // 한국 시간대로 변환 (UTC + 9시간)
                                    const date = new Date(tooltipItem.raw.x);
                                    date.setHours(date.getHours() - 9);  // 9시간 더해서 한국 시간대로 변환
                                    
                                    const time = date.toLocaleString('ko-KR', {
                                        hour: '2-digit', 
                                        minute: '2-digit', 
                                        hour12: true 
                                    });
                    
                                    return `현재가: ${currentPrice}, 시간: ${time}`;
                                }
                                return '';  // 다른 차트에는 툴팁을 표시하지 않음
                            }
                        }
                    }
                      
                    
                }
            }
        });
    }

    
    function calculateMinDate(years) {
        const minDate = new Date(maxDate);
        minDate.setFullYear(minDate.getFullYear() - years);
        return minDate;
    }

    // 라인 차트 설정
    function renderLineChart(years) {
        if (stockChart) {
            stockChart.destroy();  // 기존 차트를 삭제
        }

        const minDate = calculateMinDate(years);  // 기간에 맞는 최소 날짜 계산
        const filteredDates = dates.filter((date, index) => new Date(date) >= minDate);  // 선택한 기간에 해당하는 날짜 필터링
        const filteredClosingPrices = closingPrices.slice(dates.length - filteredDates.length);  // 필터링된 날짜에 맞는 종가 데이터

        // 선택한 기간에 맞는 최고가와 최저가 계산
        const filteredMinPrice = Math.min(...filteredClosingPrices);
        const filteredMaxPrice = Math.max(...filteredClosingPrices);

        // 최고가와 최저가의 인덱스 계산
        const filteredMinPriceIndex = filteredClosingPrices.indexOf(filteredMinPrice);
        const filteredMaxPriceIndex = filteredClosingPrices.indexOf(filteredMaxPrice);

        // 1년 선택 시 이동평균선을 표시
        const datasets = [{
            label: '종가',
            data: filteredClosingPrices,
            borderColor: 'rgba(14, 138, 117, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderWidth: 1,
            pointRadius: 0,
            tension: 0.1
        }, {
            label: '최고가',
            data: [{x: filteredDates[filteredMaxPriceIndex], y: filteredMaxPrice}],  // 필터링된 최고가에 마커 추가
            pointRadius: 5,
            pointBackgroundColor: 'red',  // 마커 색상
            pointBorderColor: 'red',
            showLine: false, // 선은 그리지 않고 마커만 표시
            legend: { display: false } // 범례 숨김


        }, {
            label: '최저가',
            data: [{x: filteredDates[filteredMinPriceIndex], y: filteredMinPrice}],  // 필터링된 최저가에 마커 추가
            pointRadius: 5,
            pointBackgroundColor: 'blue',  // 마커 색상
            pointBorderColor: 'blue',
            showLine: false,// 선은 그리지 않고 마커만 표시
        }];

        // 1년 선택 시 이동평균선 추가
        if (years === 1) {
            const filteredMA5 = ma5.slice(dates.length - filteredDates.length);
            const filteredMA20 = ma20.slice(dates.length - filteredDates.length);
            const filteredMA60 = ma60.slice(dates.length - filteredDates.length);
            const filteredMA120 = ma120.slice(dates.length - filteredDates.length);

            datasets.push({
                label: 'MA5',
                data: filteredMA5,
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 0.6,
                pointRadius: 0,
                tension: 0.1
            }, {
                label: 'MA20',
                data: filteredMA20,
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 0.6,
                pointRadius: 0,
                tension: 0.1
            }, {
                label: 'MA60',
                data: filteredMA60,
                borderColor: 'rgba(255, 206, 86, 1)',
                borderWidth: 0.6,
                pointRadius: 0,
                tension: 0.1
            }, {
                label: 'MA120',
                data: filteredMA120,
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 0.6,
                pointRadius: 0,
                tension: 0.1
            });
        }

        stockChart = new Chart(document.getElementById('stockChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: filteredDates,  // 필터링된 날짜 사용
                datasets: datasets  // 데이터셋 추가
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        min: minDate.toISOString(),  // 해당 기간에 맞는 최소 날짜 설정
                        max: maxDate.toISOString(),
                        title: { display: true, text: '날짜' }
                    },
                    y: { 
                        title: { display: true, text: '가격 (원)' }, 
                        beginAtZero: false 
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            // 특정 데이터셋을 범례에서 숨기기 위한 필터링
                            filter: function(legendItem, data) {
                                // '최고가'와 '최저가' 항목을 필터링하여 범례에서 숨김
                                return legendItem.text !== '최고가' && legendItem.text !== '최저가';
                            }
                        }
                    },
                
                }
            }
        });
    }
    // 차트 기간 선택 버튼 이벤트 처리
    const rangeButtons = document.querySelectorAll('#rangeButtons button');
    rangeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const years = parseInt(this.id.replace('range', ''));
            if (years === 0) {
                fetchRealTimeData();  // 1일 버튼 클릭 시 실시간 데이터를 봉차트로 업데이트
            } else {
                renderLineChart(years);  // 나머지 경우는 라인 차트로 업데이트
            }
            updateActiveButton(this);  // 클릭한 버튼을 활성화 상태로 업데이트
        });
    });

    // 클릭한 버튼을 활성화 상태로 설정하는 함수
    function updateActiveButton(clickedButton) {
        rangeButtons.forEach(button => {
            button.classList.remove('active', 'btn-primary');
            button.classList.add('btn-secondary');
        });

        clickedButton.classList.remove('btn-secondary');
        clickedButton.classList.add('active', 'btn-primary');
    }

    // 초기 차트 렌더링 (라인 차트로 10년 기간 보여줌)
    renderLineChart(10);
</script>

{% endblock %}
