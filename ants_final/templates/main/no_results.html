{% extends 'base.html' %}
{% load static %}

{% block title %}ANTS{% endblock %}

{% block content %}
<div class="container">
    <form method="GET" action="{% url 'stock_search' %}">
        <input type="text" name="stock_query" placeholder="종목 코드 또는 종목명을 입력하세요" required>
        <button type="submit" class="btn btn-dark">검색</button>
    </form>

</div>

<div class="container">
    <h2>{{ stock_query }}에 대한 검색 결과가 없습니다.</h2>
    <a href="{% url 'home' %}">홈으로 돌아가기</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 장고에서 전달된 데이터를 JavaScript에서 사용
    const dates = {{ dates|safe }};
    const closingPrices = {{ closing_prices|safe }};
    const stock_code = "{{ stock_code }}";  // Django 템플릿에서 전달받은 stock_code를 JavaScript 변수로 저장

    // Chart.js로 그래프 그리기
    const ctx = document.getElementById('stockChart').getContext('2d');
    const stockChart = new Chart(ctx, {
        type: 'line',  // 라인 차트 타입
        data: {
            labels: dates,  // x축에 날짜 데이터
            datasets: [{
                label: '종가',
                data: closingPrices,  // y축에 주가 데이터
                borderColor: 'rgba(75, 192, 192, 1)',  // 선 색상
                backgroundColor: 'rgba(75, 192, 192, 0.2)',  // 배경 색상
                borderWidth: 1,
                pointRadius: 2,  // 포인터 크기를 줄임
                pointHoverRadius: 4,  // 포인터에 마우스를 올렸을 때 크기
                pointBorderColor: 'rgba(75, 192, 192, 1)',  // 포인터 테두리 색상
                pointBackgroundColor: 'rgba(75, 192, 192, 0.5)'  // 포인터 배경 색상
            }]
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '날짜'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: '가격 (원)'
                    },
                    beginAtZero: false  // 주가에 맞게 0부터 시작하지 않도록
                }
            }
        }
    });

    let currentPage = 1;
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const newsWrapper = document.getElementById('newsWrapper');

    function loadNews(page) {
        fetch(`/load-news/?stock_code={{ stock_code }}&page=${page}`)
            .then(response => response.json())
            .then(data => {
                newsWrapper.innerHTML = '';
                data.news_list.forEach(news => {
                    const newsItem = document.createElement('div');
                    newsItem.classList.add('news-item');
                    newsItem.innerHTML = `<h4>${news.title}</h4><p>${news.description}</p>`;
                    newsWrapper.appendChild(newsItem);
                });
            });
    }

    prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            loadNews(currentPage);
        }
    });

    nextBtn.addEventListener('click', () => {
        currentPage++;
        loadNews(currentPage);
    });
</script>
{% endblock %}
